// --- KONFIGURASI ---
generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
  binaryTargets   = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pg_trgm] // Definisikan extension pg_trgm
}

// --- ENUMS (Standarisasi Data) ---
enum Role {
  USER
  ADMIN
  DIRECTOR
}

enum HealthStatus {
  SEHAT
  WASPADA
  BAHAYA
}

enum EducationMethod {
  ARITHMETIC // Konvensional
  GEOMETRIC // Inflasi Progresif
}

enum SchoolLevel {
  TK
  SD
  SMP
  SMA
  S1
  S2
}

enum CostType {
  ENTRY // Uang Pangkal
  ANNUAL // SPP Tahunan
}

enum InsuranceType {
  LIFE
  HEALTH
  CRITICAL_ILLNESS
}

// --- MASTER DATA ---

model UnitKerja {
  id        String   @id @default(uuid())
  kodeUnit  String   @unique @map("kode_unit") // e.g. "IT-01"
  namaUnit  String   @map("nama_unit") // e.g. "Divisi TI"
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relasi
  users User[]

  @@map("unit_kerja")
}

// --- USER MANAGEMENT & SECURITY ---

model User {
  id           String @id @default(uuid())
  unitKerjaId  String @map("unit_kerja_id")
  nip          String @unique
  email        String @unique
  passwordHash String @map("password_hash")
  fullName     String @map("full_name")

  // [NEW] Avatar Field
  avatar String? @db.Text

  dateOfBirth    DateTime @map("date_of_birth") // Penting untuk pensiun
  dependentCount Int      @default(0) @map("dependent_count")
  role           Role     @default(USER)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relasi
  unitKerja UnitKerja @relation(fields: [unitKerjaId], references: [id])

  // Relasi ke Fitur
  budgetPlans     BudgetPlan[]
  financialChecks FinancialCheckup[]
  eduPlans        EducationPlan[]
  pensionPlans    PensionPlan[]
  insurancePlans  InsurancePlan[]
  goalPlans       GoalPlan[]

  // Relasi Audit
  actionsPerformed AccessLog[]    @relation("ActorRelation")
  actionsTargeted  AccessLog[]    @relation("TargetRelation")
  RetentionLog     RetentionLog[]

  // [OPTIMIZATION] Index FK untuk mempercepat JOIN Unit Kerja
  @@index([unitKerjaId])
  @@map("users")
}

// --- AUDIT TRAIL (Untuk Dashboard Direksi) ---

model AccessLog {
  id           String   @id @default(uuid())
  actorId      String   @map("actor_id") // Siapa yang melihat? (Direksi)
  targetUserId String?  @map("target_user_id") // Data siapa? (Karyawan)
  action       String // VIEW_DETAIL, DOWNLOAD_PDF, UPDATE_PROFILE
  metadata     Json? // Detail tambahan
  accessedAt   DateTime @default(now()) @map("accessed_at")

  // Relasi
  actor      User  @relation("ActorRelation", fields: [actorId], references: [id])
  targetUser User? @relation("TargetRelation", fields: [targetUserId], references: [id])

  @@map("access_logs")
}

// --- FINANCIAL ENGINE: 5 POS ANGGARAN ---

model BudgetPlan {
  id     String @id @default(uuid())
  userId String @map("user_id")
  month  Int
  year   Int

  fixedIncome    Decimal @map("fixed_income") @db.Decimal(15, 2)
  variableIncome Decimal @default(0) @map("variable_income") @db.Decimal(15, 2)

  productiveDebt  Decimal @default(0) @map("productive_debt") @db.Decimal(15, 2)
  consumptiveDebt Decimal @default(0) @map("consumptive_debt") @db.Decimal(15, 2)
  insurance       Decimal @default(0) @map("insurance") @db.Decimal(15, 2)
  saving          Decimal @default(0) @map("saving") @db.Decimal(15, 2)
  livingCost      Decimal @default(0) @map("living_cost") @db.Decimal(15, 2)

  totalIncome  Decimal @map("total_income") @db.Decimal(15, 2)
  totalExpense Decimal @map("total_expense") @db.Decimal(15, 2)
  balance      Decimal @map("balance") @db.Decimal(15, 2)
  status       String

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id])

  @@map("budget_plans")
}

// --- FINANCIAL ENGINE: GRANULAR CHECKUP ---

model FinancialCheckup {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  checkDate DateTime @default(now()) @map("check_date")

  // --- [NEW] TAMBAHKAN DUA BARIS INI ---
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  // -------------------------------------

  userProfile   Json  @map("user_profile")
  spouseProfile Json? @map("spouse_profile")

  // Aset & Utang
  assetCash          Decimal @default(0) @map("asset_cash") @db.Decimal(15, 2)
  assetHome          Decimal @default(0) @map("asset_home") @db.Decimal(15, 2)
  assetVehicle       Decimal @default(0) @map("asset_vehicle") @db.Decimal(15, 2)
  assetJewelry       Decimal @default(0) @map("asset_jewelry") @db.Decimal(15, 2)
  assetAntique       Decimal @default(0) @map("asset_antique") @db.Decimal(15, 2)
  assetPersonalOther Decimal @default(0) @map("asset_personal_other") @db.Decimal(15, 2)

  assetInvHome    Decimal @default(0) @map("asset_inv_home") @db.Decimal(15, 2)
  assetInvVehicle Decimal @default(0) @map("asset_inv_vehicle") @db.Decimal(15, 2)
  assetGold       Decimal @default(0) @map("asset_gold") @db.Decimal(15, 2)
  assetInvAntique Decimal @default(0) @map("asset_inv_antique") @db.Decimal(15, 2)
  assetStocks     Decimal @default(0) @map("asset_stocks") @db.Decimal(15, 2)
  assetMutualFund Decimal @default(0) @map("asset_mutual_fund") @db.Decimal(15, 2)
  assetBonds      Decimal @default(0) @map("asset_bonds") @db.Decimal(15, 2)
  assetDeposit    Decimal @default(0) @map("asset_deposit") @db.Decimal(15, 2)
  assetInvOther   Decimal @default(0) @map("asset_inv_other") @db.Decimal(15, 2)

  debtKPR              Decimal @default(0) @map("debt_kpr") @db.Decimal(15, 2)
  debtKPM              Decimal @default(0) @map("debt_kpm") @db.Decimal(15, 2)
  debtCC               Decimal @default(0) @map("debt_cc") @db.Decimal(15, 2)
  debtCoop             Decimal @default(0) @map("debt_coop") @db.Decimal(15, 2)
  debtConsumptiveOther Decimal @default(0) @map("debt_consumptive_other") @db.Decimal(15, 2)
  debtBusiness         Decimal @default(0) @map("debt_business") @db.Decimal(15, 2)

  incomeFixed    Decimal @default(0) @map("income_fixed") @db.Decimal(15, 2)
  incomeVariable Decimal @default(0) @map("income_variable") @db.Decimal(15, 2)

  installmentKPR              Decimal @default(0) @map("installment_kpr") @db.Decimal(15, 2)
  installmentKPM              Decimal @default(0) @map("installment_kpm") @db.Decimal(15, 2)
  installmentCC               Decimal @default(0) @map("installment_cc") @db.Decimal(15, 2)
  installmentCoop             Decimal @default(0) @map("installment_coop") @db.Decimal(15, 2)
  installmentConsumptiveOther Decimal @default(0) @map("installment_consumptive_other") @db.Decimal(15, 2)
  installmentBusiness         Decimal @default(0) @map("installment_business") @db.Decimal(15, 2)

  insuranceLife    Decimal @default(0) @map("insurance_life") @db.Decimal(15, 2)
  insuranceHealth  Decimal @default(0) @map("insurance_health") @db.Decimal(15, 2)
  insuranceHome    Decimal @default(0) @map("insurance_home") @db.Decimal(15, 2)
  insuranceVehicle Decimal @default(0) @map("insurance_vehicle") @db.Decimal(15, 2)
  insuranceBPJS    Decimal @default(0) @map("insurance_bpjs") @db.Decimal(15, 2)
  insuranceOther   Decimal @default(0) @map("insurance_other") @db.Decimal(15, 2)

  savingEducation  Decimal @default(0) @map("saving_education") @db.Decimal(15, 2)
  savingRetirement Decimal @default(0) @map("saving_retirement") @db.Decimal(15, 2)
  savingPilgrimage Decimal @default(0) @map("saving_pilgrimage") @db.Decimal(15, 2)
  savingHoliday    Decimal @default(0) @map("saving_holiday") @db.Decimal(15, 2)
  savingEmergency  Decimal @default(0) @map("saving_emergency") @db.Decimal(15, 2)
  savingOther      Decimal @default(0) @map("saving_other") @db.Decimal(15, 2)

  expenseFood          Decimal @default(0) @map("expense_food") @db.Decimal(15, 2)
  expenseSchool        Decimal @default(0) @map("expense_school") @db.Decimal(15, 2)
  expenseTransport     Decimal @default(0) @map("expense_transport") @db.Decimal(15, 2)
  expenseCommunication Decimal @default(0) @map("expense_communication") @db.Decimal(15, 2)
  expenseHelpers       Decimal @default(0) @map("expense_helpers") @db.Decimal(15, 2)
  expenseTax           Decimal @default(0) @map("expense_tax") @db.Decimal(15, 2)
  expenseLifestyle     Decimal @default(0) @map("expense_lifestyle") @db.Decimal(15, 2)

  expenseOther         Decimal @default(0) @map("expense_other") @db.Decimal(15, 2)

  totalNetWorth  Decimal      @default(0) @map("total_net_worth") @db.Decimal(15, 2)
  surplusDeficit Decimal      @default(0) @map("surplus_deficit") @db.Decimal(15, 2)
  healthScore    Int          @default(0) @map("health_score")
  status         HealthStatus @default(BAHAYA)

  ratiosDetails Json @map("ratios_details")

  user User @relation(fields: [userId], references: [id])

  // [OPTIMIZATION]
  // 1. Composite Index: Mempercepat query "ORDER BY checkDate DESC" per user
  // 2. Status Index: Mempercepat filtering statistik global (Count Sehat/Bahaya)
  @@index([userId, checkDate(sort: Desc)])
  @@index([status])
  @@map("financial_checkups")
}

// --- FINANCIAL ENGINE: EDUCATION PLANNING ---

model EducationPlan {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  childName String   @map("child_name")
  childDob  DateTime @map("child_dob")

  inflationRate Decimal         @default(10.0) @map("inflation_rate") @db.Decimal(5, 2)
  returnRate    Decimal         @default(12.0) @map("return_rate") @db.Decimal(5, 2)
  method        EducationMethod @default(GEOMETRIC)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user   User             @relation(fields: [userId], references: [id])
  stages EducationStage[]

  @@map("education_plans")
}

model EducationStage {
  id       String      @id @default(uuid())
  planId   String      @map("plan_id")
  level    SchoolLevel
  costType CostType    @map("cost_type")

  currentCost Decimal @map("current_cost") @db.Decimal(15, 2)
  futureCost  Decimal @map("future_cost") @db.Decimal(15, 2)

  yearsToStart  Int     @map("years_to_start")
  monthlySaving Decimal @map("monthly_saving") @db.Decimal(15, 2)

  plan EducationPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@map("education_stages")
}

// --- FINANCIAL ENGINE: PENSION PLANNING (NEW) ---

model PensionPlan {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  // [NEW] Tambahkan baris ini
  updatedAt DateTime @updatedAt @map("updated_at")

  // Input Data
  currentAge     Int @map("current_age")
  retirementAge  Int @map("retirement_age")
  lifeExpectancy Int @default(80) @map("life_expectancy")

  currentExpense Decimal @map("current_expense") @db.Decimal(15, 2)
  currentSaving  Decimal @default(0) @map("current_saving") @db.Decimal(15, 2)

  inflationRate Decimal @default(5.0) @map("inflation_rate") @db.Decimal(5, 2)
  returnRate    Decimal @default(8.0) @map("return_rate") @db.Decimal(5, 2)

  // Output Calculation
  totalFundNeeded Decimal @map("total_fund_needed") @db.Decimal(15, 2)
  monthlySaving   Decimal @map("monthly_saving") @db.Decimal(15, 2)

  user User @relation(fields: [userId], references: [id])

  @@map("pension_plans")
}

// --- FINANCIAL ENGINE: INSURANCE PLANNING (NEW) ---

// Cari block model InsurancePlan dan tambahkan 2 field baru ini

model InsurancePlan {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  type InsuranceType @default(LIFE)

  // Input Data
  dependentCount     Int     @default(0) @map("dependent_count")
  monthlyExpense     Decimal @map("monthly_expense") @db.Decimal(15, 2)
  existingDebt       Decimal @default(0) @map("existing_debt") @db.Decimal(15, 2)
  existingCoverage   Decimal @default(0) @map("existing_coverage") @db.Decimal(15, 2)
  protectionDuration Int     @default(10) @map("protection_duration")

  // [NEW] Tambahkan baris ini
  updatedAt DateTime @updatedAt @map("updated_at")

  // [FIX] Tambahkan 2 Field ini agar error TypeScript hilang & Data tersimpan
  inflationRate Decimal @default(5.0) @map("inflation_rate") @db.Decimal(5, 2)
  returnRate    Decimal @default(7.0) @map("return_rate") @db.Decimal(5, 2)
  // --- [NEW] Tambahkan baris ini ---
  finalExpense  Decimal @default(0) @db.Decimal(15, 2)

  // Output Calculation
  coverageNeeded Decimal @map("coverage_needed") @db.Decimal(15, 2)
  recommendation String? @db.Text

  user User @relation(fields: [userId], references: [id])

  @@map("insurance_plans")
}

// --- FINANCIAL ENGINE: GOAL PLANNING (NEW) ---

model GoalPlan {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  // [NEW] Tambahkan baris ini
  updatedAt DateTime @updatedAt @map("updated_at")

  // Input Data
  goalName     String  @map("goal_name")
  targetAmount Decimal @map("target_amount") @db.Decimal(15, 2)

  targetDate DateTime @map("target_date")

  inflationRate Decimal @default(5.0) @map("inflation_rate") @db.Decimal(5, 2)
  returnRate    Decimal @default(6.0) @map("return_rate") @db.Decimal(5, 2)

  // Output Calculation
  futureValue   Decimal @map("future_value") @db.Decimal(15, 2)
  monthlySaving Decimal @map("monthly_saving") @db.Decimal(15, 2)

  user User @relation(fields: [userId], references: [id])

  @@map("goal_plans")
}

// --- MARKET DATA (External API Config) ---

model GoldPriceHistory {
  id String @id @default(uuid())

  buyPrice  Decimal @map("buy_price") @db.Decimal(10, 2)
  sellPrice Decimal @map("sell_price") @db.Decimal(10, 2)

  openPrice    Decimal? @map("open_price") @db.Decimal(10, 2)
  changeAmount Decimal? @map("change_amount") @db.Decimal(10, 2)

  currency String @default("IDR") @map("currency")
  unit     String @default("GRAM") @map("unit")
  source   String @map("source")

  fetchedAt DateTime @default(now()) @map("fetched_at")

  @@index([fetchedAt])
  @@map("gold_price_histories")
}

// --- SYSTEM MAINTENANCE & AUDIT ---

model RetentionLog {
  id         String @id @default(uuid())
  executorId String @map("executor_id") // Admin yang eksekusi

  entityType String @map("entity_type") // e.g., FINANCIAL_CHECKUP
  action     String @default("PRUNE") // Enum: PRUNE, ARCHIVE

  recordsDeleted Int      @map("records_deleted")
  cutoffDate     DateTime @map("cutoff_date") // Data setua apa yang dihapus?

  executedAt DateTime @default(now()) @map("executed_at")
  metadata   Json? // Simpan detail lain (misal: duration, export_ref)

  // Relasi
  executor User @relation(fields: [executorId], references: [id])

  @@index([executedAt])
  @@map("retention_logs")
}
