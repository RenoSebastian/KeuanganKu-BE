// --- KONFIGURASI ---
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS (Standarisasi Data) ---
enum Role {
  USER
  ADMIN
  DIRECTOR
}

enum HealthStatus {
  SEHAT
  WASPADA
  BAHAYA
}

enum EducationMethod {
  ARITHMETIC // Konvensional
  GEOMETRIC  // Inflasi Progresif
}

enum SchoolLevel {
  TK
  SD
  SMP
  SMA
  PT
}

enum CostType {
  ENTRY  // Uang Pangkal
  ANNUAL // SPP Tahunan
}

// --- MASTER DATA ---

model UnitKerja {
  id        String   @id @default(uuid())
  kodeUnit  String   @unique @map("kode_unit") // e.g. "IT-01"
  namaUnit  String   @map("nama_unit")          // e.g. "Divisi TI"
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relasi
  users     User[]

  @@map("unit_kerja")
}

// --- USER MANAGEMENT & SECURITY ---

model User {
  id             String    @id @default(uuid())
  unitKerjaId    String    @map("unit_kerja_id")
  nip            String    @unique
  email          String    @unique
  passwordHash   String    @map("password_hash")
  fullName       String    @map("full_name")
  dateOfBirth    DateTime  @map("date_of_birth") // Penting untuk pensiun
  dependentCount Int       @default(0) @map("dependent_count")
  role           Role      @default(USER)
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relasi
  unitKerja       UnitKerja @relation(fields: [unitKerjaId], references: [id])
  
  // Relasi ke Fitur
  budgetPlans     BudgetPlan[]
  financialChecks FinancialCheckup[]
  eduPlans        EducationPlan[]
  
  // Relasi Audit (User bisa melakukan aksi, atau menjadi target aksi direksi)
  actionsPerformed AccessLog[] @relation("ActorRelation")
  actionsTargeted  AccessLog[] @relation("TargetRelation")

  @@map("users")
}

// --- AUDIT TRAIL (Untuk Dashboard Direksi) ---

model AccessLog {
  id           String   @id @default(uuid())
  actorId      String   @map("actor_id") // Siapa yang melihat? (Direksi)
  targetUserId String?  @map("target_user_id") // Data siapa? (Karyawan)
  action       String   // VIEW_DETAIL, DOWNLOAD_PDF, UPDATE_PROFILE
  metadata     Json?    // Detail tambahan (IP Address, Browser, dll)
  accessedAt   DateTime @default(now()) @map("accessed_at")

  // Relasi
  actor        User      @relation("ActorRelation", fields: [actorId], references: [id])
  targetUser   User?     @relation("TargetRelation", fields: [targetUserId], references: [id])

  @@map("access_logs")
}

// --- FINANCIAL ENGINE: 5 POS ANGGARAN ---

model BudgetPlan {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  month           Int      // 1-12
  year            Int      // 2025
  
  // Income
  fixedIncome     Decimal  @map("fixed_income")     @db.Decimal(15, 2)
  variableIncome  Decimal  @default(0) @map("variable_income") @db.Decimal(15, 2)

  // 5 Pos Pengeluaran (Sesuai Rules yang kita bahas di FE)
  productiveDebt  Decimal  @default(0) @map("productive_debt") @db.Decimal(15, 2)
  consumptiveDebt Decimal  @default(0) @map("consumptive_debt") @db.Decimal(15, 2)
  insurance       Decimal  @default(0) @map("insurance")       @db.Decimal(15, 2)
  saving          Decimal  @default(0) @map("saving")          @db.Decimal(15, 2)
  livingCost      Decimal  @default(0) @map("living_cost")     @db.Decimal(15, 2)

  // Summary Logic
  totalIncome     Decimal  @map("total_income") @db.Decimal(15, 2)
  totalExpense    Decimal  @map("total_expense") @db.Decimal(15, 2)
  balance         Decimal  @map("balance") @db.Decimal(15, 2)
  status          String   // "DEFISIT" | "SURPLUS" | "BALANCED"

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user            User     @relation(fields: [userId], references: [id])

  @@map("budget_plans")
}

// --- FINANCIAL ENGINE: GRANULAR CHECKUP (UPDATED) ---
// Mencerminkan struktur data rinci dari Frontend
model FinancialCheckup {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  checkDate DateTime @default(now()) @map("check_date")

  // 1. Metadata (Snapshot Profil saat checkup)
  // Menyimpan Nama, Tgl Lahir, Agama, Suku, dll dalam JSON agar fleksibel
  userProfile   Json @map("user_profile")
  spouseProfile Json? @map("spouse_profile")

  // 2. NERACA ASET (HARTA)
  // A. Aset Likuid
  assetCash          Decimal @default(0) @map("asset_cash") @db.Decimal(15, 2)
  
  // B. Aset Personal
  assetHome          Decimal @default(0) @map("asset_home") @db.Decimal(15, 2)
  assetVehicle       Decimal @default(0) @map("asset_vehicle") @db.Decimal(15, 2)
  assetJewelry       Decimal @default(0) @map("asset_jewelry") @db.Decimal(15, 2)
  assetAntique       Decimal @default(0) @map("asset_antique") @db.Decimal(15, 2)
  assetPersonalOther Decimal @default(0) @map("asset_personal_other") @db.Decimal(15, 2)
  
  // C. Aset Investasi
  assetInvHome       Decimal @default(0) @map("asset_inv_home") @db.Decimal(15, 2)
  assetInvVehicle    Decimal @default(0) @map("asset_inv_vehicle") @db.Decimal(15, 2)
  assetGold          Decimal @default(0) @map("asset_gold") @db.Decimal(15, 2)
  assetInvAntique    Decimal @default(0) @map("asset_inv_antique") @db.Decimal(15, 2)
  assetStocks        Decimal @default(0) @map("asset_stocks") @db.Decimal(15, 2)
  assetMutualFund    Decimal @default(0) @map("asset_mutual_fund") @db.Decimal(15, 2)
  assetBonds         Decimal @default(0) @map("asset_bonds") @db.Decimal(15, 2)
  assetDeposit       Decimal @default(0) @map("asset_deposit") @db.Decimal(15, 2)
  assetInvOther      Decimal @default(0) @map("asset_inv_other") @db.Decimal(15, 2)

  // 3. NERACA UTANG (KEWAJIBAN)
  // E. Utang Konsumtif
  debtKPR              Decimal @default(0) @map("debt_kpr") @db.Decimal(15, 2)
  debtKPM              Decimal @default(0) @map("debt_kpm") @db.Decimal(15, 2)
  debtCC               Decimal @default(0) @map("debt_cc") @db.Decimal(15, 2)
  debtCoop             Decimal @default(0) @map("debt_coop") @db.Decimal(15, 2)
  debtConsumptiveOther Decimal @default(0) @map("debt_consumptive_other") @db.Decimal(15, 2)
  
  // F. Utang Usaha
  debtBusiness         Decimal @default(0) @map("debt_business") @db.Decimal(15, 2)

  // 4. ARUS KAS (CASHFLOW)
  // I. Pemasukan (Tahunan)
  incomeFixed    Decimal @default(0) @map("income_fixed") @db.Decimal(15, 2)
  incomeVariable Decimal @default(0) @map("income_variable") @db.Decimal(15, 2)

  // PENGELUARAN (Menyimpan input RAW dari user, logika tahunan/bulanan diurus Logic)
  
  // K. Cicilan Utang
  installmentKPR              Decimal @default(0) @map("installment_kpr") @db.Decimal(15, 2)
  installmentKPM              Decimal @default(0) @map("installment_kpm") @db.Decimal(15, 2)
  installmentCC               Decimal @default(0) @map("installment_cc") @db.Decimal(15, 2)
  installmentCoop             Decimal @default(0) @map("installment_coop") @db.Decimal(15, 2)
  installmentConsumptiveOther Decimal @default(0) @map("installment_consumptive_other") @db.Decimal(15, 2)
  installmentBusiness         Decimal @default(0) @map("installment_business") @db.Decimal(15, 2)

  // L. Premi Asuransi
  insuranceLife    Decimal @default(0) @map("insurance_life") @db.Decimal(15, 2)
  insuranceHealth  Decimal @default(0) @map("insurance_health") @db.Decimal(15, 2)
  insuranceHome    Decimal @default(0) @map("insurance_home") @db.Decimal(15, 2)
  insuranceVehicle Decimal @default(0) @map("insurance_vehicle") @db.Decimal(15, 2)
  insuranceBPJS    Decimal @default(0) @map("insurance_bpjs") @db.Decimal(15, 2)
  insuranceOther   Decimal @default(0) @map("insurance_other") @db.Decimal(15, 2)

  // M. Tabungan/Investasi
  savingEducation  Decimal @default(0) @map("saving_education") @db.Decimal(15, 2)
  savingRetirement Decimal @default(0) @map("saving_retirement") @db.Decimal(15, 2)
  savingPilgrimage Decimal @default(0) @map("saving_pilgrimage") @db.Decimal(15, 2)
  savingHoliday    Decimal @default(0) @map("saving_holiday") @db.Decimal(15, 2)
  savingEmergency  Decimal @default(0) @map("saving_emergency") @db.Decimal(15, 2)
  savingOther      Decimal @default(0) @map("saving_other") @db.Decimal(15, 2)

  // N. Belanja Keluarga
  expenseFood          Decimal @default(0) @map("expense_food") @db.Decimal(15, 2)
  expenseSchool        Decimal @default(0) @map("expense_school") @db.Decimal(15, 2)
  expenseTransport     Decimal @default(0) @map("expense_transport") @db.Decimal(15, 2)
  expenseCommunication Decimal @default(0) @map("expense_communication") @db.Decimal(15, 2)
  expenseHelpers       Decimal @default(0) @map("expense_helpers") @db.Decimal(15, 2)
  expenseTax           Decimal @default(0) @map("expense_tax") @db.Decimal(15, 2)
  expenseLifestyle     Decimal @default(0) @map("expense_lifestyle") @db.Decimal(15, 2)

  // --- HASIL ANALISA (Computed by Backend Logic) ---
  totalNetWorth  Decimal      @default(0) @map("total_net_worth") @db.Decimal(15, 2) // H
  surplusDeficit Decimal      @default(0) @map("surplus_deficit") @db.Decimal(15, 2) // Q
  healthScore    Int          @default(0) @map("health_score")
  status         HealthStatus @default(BAHAYA)
  
  // Menyimpan detail 8 rasio (value, benchmark, status per rasio) sebagai JSON
  ratiosDetails  Json         @map("ratios_details") 

  user User @relation(fields: [userId], references: [id])

  @@map("financial_checkups")
}

// --- FINANCIAL ENGINE: EDUCATION PLANNING ---

model EducationPlan {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  childName      String   @map("child_name")
  childDob       DateTime @map("child_dob")
  
  // Assumptions
  inflationRate  Decimal  @default(10.0) @map("inflation_rate") @db.Decimal(5, 2) // Default 10%
  returnRate     Decimal  @default(12.0) @map("return_rate") @db.Decimal(5, 2) // Asumsi Investasi
  method         EducationMethod @default(GEOMETRIC)

  createdAt      DateTime @default(now()) @map("created_at")
  
  // Relasi
  user           User     @relation(fields: [userId], references: [id])
  stages         EducationStage[]

  @@map("education_plans")
}

model EducationStage {
  id             String   @id @default(uuid())
  planId         String   @map("plan_id")
  level          SchoolLevel
  costType       CostType @map("cost_type") // Uang Pangkal vs Tahunan
  
  currentCost    Decimal  @map("current_cost") @db.Decimal(15, 2) // Biaya Sekarang (PV)
  futureCost     Decimal  @map("future_cost") @db.Decimal(15, 2)  // Biaya Nanti (FV)
  
  yearsToStart   Int      @map("years_to_start") // n tahun lagi
  monthlySaving  Decimal  @map("monthly_saving") @db.Decimal(15, 2) // PMT (Tabungan bulanan)

  plan           EducationPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@map("education_stages")
}